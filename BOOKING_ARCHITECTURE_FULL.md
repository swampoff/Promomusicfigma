# üé∏ BOOKING –°–ò–°–¢–ï–ú–ê - –ü–û–õ–ù–ê–Ø –ê–†–•–ò–¢–ï–ö–¢–£–†–ê –î–õ–Ø –ê–†–¢–ò–°–¢–û–í –ò –ó–ê–í–ï–î–ï–ù–ò–ô

**–î–∞—Ç–∞:** 3 —Ñ–µ–≤—Ä–∞–ª—è 2026  
**–í–µ—Ä—Å–∏—è:** 2.0 - –î–≤—É—Å—Ç–æ—Ä–æ–Ω–Ω—è—è –±—É–∫–∏–Ω–≥-—Å–∏—Å—Ç–µ–º–∞  

---

## üèóÔ∏è –û–ë–©–ê–Ø –ê–†–•–ò–¢–ï–ö–¢–£–†–ê

### **–£—á–∞—Å—Ç–Ω–∏–∫–∏ —Å–∏—Å—Ç–µ–º—ã:**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  –ó–ê–í–ï–î–ï–ù–ò–ï  ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ   –ü–õ–ê–¢–§–û–†–ú–ê  ‚îÇ‚óÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ  –ê–†–¢–ò–°–¢/DJ  ‚îÇ
‚îÇ   (Venue)   ‚îÇ         ‚îÇ promo.music  ‚îÇ         ‚îÇ  (Artist)   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
      ‚îÇ                        ‚îÇ                         ‚îÇ
      ‚îÇ –°–æ–∑–¥–∞–µ—Ç –∑–∞—è–≤–∫—É        ‚îÇ –ö–æ–º–∏—Å—Å–∏—è 10%           ‚îÇ –ü—Ä–∏–Ω–∏–º–∞–µ—Ç
      ‚îÇ –û–ø–ª–∞—á–∏–≤–∞–µ—Ç            ‚îÇ –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç —Å–¥–µ–ª–∫—É     ‚îÇ –ü–æ–ª—É—á–∞–µ—Ç –≤—ã–ø–ª–∞—Ç—É
      ‚îÇ –û—Å—Ç–∞–≤–ª—è–µ—Ç –æ—Ç–∑—ã–≤       ‚îÇ –ú–æ–¥–µ—Ä–∏—Ä—É–µ—Ç             ‚îÇ –£–ø—Ä–∞–≤–ª—è–µ—Ç –∫–∞–ª–µ–Ω–¥–∞—Ä–µ–º
      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### **–¢–∏–ø—ã performers (–∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π):**

| –¢–∏–ø | –¢–∞–±–ª–∏—Ü–∞ | –†–æ–ª—å | –û–ø–∏—Å–∞–Ω–∏–µ |
|-----|---------|------|----------|
| `artist` | `artist_profiles` | artist | –ú—É–∑—ã–∫–∞–Ω—Ç, –ø–µ–≤–µ—Ü, –≥—Ä—É–ø–ø–∞ |
| `dj` | `dj_profiles` | dj | DJ, –¥–∏–¥–∂–µ–π |
| `band` | `artist_profiles` | artist | Live band (—Ç–∏–ø –∞—Ä—Ç–∏—Å—Ç–∞) |

**–í–∞–∂–Ω–æ:** –í —Å–∏—Å—Ç–µ–º–µ –±—É–∫–∏–Ω–≥–∞ –æ–±–∞ —Ç–∏–ø–∞ (`artist` –∏ `dj`) —Ä–∞–±–æ—Ç–∞—é—Ç –æ–¥–∏–Ω–∞–∫–æ–≤–æ!

---

## üìä SQL –°–¢–†–£–ö–¢–£–†–ê

### **1. –¢–∞–±–ª–∏—Ü–∞ booking_requests**

**–û—Å–Ω–æ–≤–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –∑–∞—è–≤–æ–∫ –Ω–∞ –±—É–∫–∏–Ω–≥**

```sql
CREATE TABLE public.booking_requests (
    -- –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    -- –£—á–∞—Å—Ç–Ω–∏–∫–∏ (venue ‚Üí performer)
    requester_id UUID NOT NULL REFERENCES public.profiles(id),
    requester_type TEXT NOT NULL DEFAULT 'venue', -- venue, artist (–µ—Å–ª–∏ –∞—Ä—Ç–∏—Å—Ç –±—É–∫–∞–µ—Ç –∞—Ä—Ç–∏—Å—Ç–∞)
    performer_id UUID NOT NULL REFERENCES public.profiles(id),
    performer_type TEXT NOT NULL, -- 'artist' –∏–ª–∏ 'dj'
    
    -- –ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ
    event_type TEXT NOT NULL DEFAULT 'dj_set', -- concert, dj_set, live, corporate, wedding, private
    event_title TEXT NOT NULL,
    event_description TEXT,
    event_date DATE NOT NULL,
    start_time TIME,
    end_time TIME,
    duration_hours NUMERIC(4,1) DEFAULT 4,
    
    -- –õ–æ–∫–∞—Ü–∏—è
    venue_id UUID REFERENCES public.venue_profiles(id), -- –ï—Å–ª–∏ –∏–∑–≤–µ—Å—Ç–Ω–æ –∑–∞–≤–µ–¥–µ–Ω–∏–µ
    venue_name TEXT, -- –ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–≤–µ–¥–µ–Ω–∏—è
    venue_address TEXT,
    venue_city TEXT,
    venue_type TEXT, -- bar, club, restaurant, concert_hall, outdoor, private
    
    -- –ê—É–¥–∏—Ç–æ—Ä–∏—è
    expected_audience INTEGER,
    audience_type TEXT, -- general, vip, corporate, private
    
    -- –§–∏–Ω–∞–Ω—Å—ã
    offered_price NUMERIC(10,2) NOT NULL, -- –ü–æ–ª–Ω–∞—è —Å—É–º–º–∞ –æ—Ç –∑–∞–≤–µ–¥–µ–Ω–∏—è
    performer_fee NUMERIC(10,2), -- –°—É–º–º–∞ –∞—Ä—Ç–∏—Å—Ç—É (90%)
    platform_commission NUMERIC(10,2), -- –ö–æ–º–∏—Å—Å–∏—è –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã (10%)
    currency TEXT DEFAULT 'RUB',
    
    -- –î–µ–ø–æ–∑–∏—Ç
    deposit_amount NUMERIC(10,2), -- 30% –æ—Ç offered_price
    deposit_percentage NUMERIC(5,2) DEFAULT 30.00,
    deposit_paid_at TIMESTAMPTZ,
    deposit_transaction_id UUID REFERENCES public.payment_transactions(id),
    
    -- –§–∏–Ω–∞–ª—å–Ω—ã–π –ø–ª–∞—Ç–µ–∂
    final_amount NUMERIC(10,2), -- 70% –æ—Ç offered_price
    full_payment_at TIMESTAMPTZ,
    final_transaction_id UUID REFERENCES public.payment_transactions(id),
    
    -- –í—ã–ø–ª–∞—Ç–∞ –∞—Ä—Ç–∏—Å—Ç—É
    payout_amount NUMERIC(10,2), -- performer_fee
    payout_at TIMESTAMPTZ,
    payout_transaction_id UUID REFERENCES public.payment_transactions(id),
    payout_status TEXT DEFAULT 'pending', -- pending, processing, completed, failed
    
    -- –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è
    technical_requirements JSONB DEFAULT '{}', -- {equipment: [], sound: "", lighting: "", other: ""}
    special_requests TEXT,
    
    -- –°—Ç–∞—Ç—É—Å workflow
    status TEXT DEFAULT 'pending',
    -- pending: –æ–∂–∏–¥–∞–µ—Ç –æ—Ç–≤–µ—Ç–∞ –∞—Ä—Ç–∏—Å—Ç–∞
    -- accepted: –∞—Ä—Ç–∏—Å—Ç –ø—Ä–∏–Ω—è–ª, –∂–¥–µ—Ç –¥–µ–ø–æ–∑–∏—Ç
    -- rejected: –∞—Ä—Ç–∏—Å—Ç –æ—Ç–∫–ª–æ–Ω–∏–ª
    -- deposit_paid: –¥–µ–ø–æ–∑–∏—Ç –æ–ø–ª–∞—á–µ–Ω
    -- confirmed: –ø–æ–ª–Ω–∞—è –æ–ø–ª–∞—Ç–∞, –±—É–∫–∏–Ω–≥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω
    -- completed: –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ –ø—Ä–æ—à–ª–æ
    -- cancelled: –æ—Ç–º–µ–Ω–µ–Ω–æ
    -- refunded: –≤–æ–∑–≤—Ä–∞—Ç —Å—Ä–µ–¥—Å—Ç–≤
    
    -- –û—Ç–º–µ–Ω–∞
    cancellation_reason TEXT,
    cancelled_by UUID REFERENCES public.profiles(id),
    cancelled_at TIMESTAMPTZ,
    cancellation_fee NUMERIC(10,2) DEFAULT 0, -- –®—Ç—Ä–∞—Ñ –∑–∞ –æ—Ç–º–µ–Ω—É
    refund_amount NUMERIC(10,2),
    refund_processed_at TIMESTAMPTZ,
    
    -- –û—Ç–∑—ã–≤—ã (–ø–æ—Å–ª–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è)
    venue_review_id UUID REFERENCES public.venue_artist_reviews(id),
    artist_review_id UUID REFERENCES public.venue_artist_reviews(id),
    
    -- –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
    created_at TIMESTAMPTZ DEFAULT now(),
    updated_at TIMESTAMPTZ DEFAULT now(),
    accepted_at TIMESTAMPTZ,
    rejected_at TIMESTAMPTZ,
    
    -- Constraints
    CONSTRAINT valid_status CHECK (status IN (
        'pending', 'accepted', 'rejected', 'deposit_paid', 
        'confirmed', 'completed', 'cancelled', 'refunded'
    )),
    CONSTRAINT valid_event_type CHECK (event_type IN (
        'concert', 'dj_set', 'live', 'corporate', 'wedding', 'private'
    )),
    CONSTRAINT valid_performer_type CHECK (performer_type IN ('artist', 'dj')),
    CONSTRAINT valid_payout_status CHECK (payout_status IN (
        'pending', 'processing', 'completed', 'failed'
    ))
);

-- –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
CREATE INDEX idx_booking_requests_requester ON public.booking_requests(requester_id);
CREATE INDEX idx_booking_requests_performer ON public.booking_requests(performer_id);
CREATE INDEX idx_booking_requests_status ON public.booking_requests(status);
CREATE INDEX idx_booking_requests_event_date ON public.booking_requests(event_date);
CREATE INDEX idx_booking_requests_created_at ON public.booking_requests(created_at);
CREATE INDEX idx_booking_requests_performer_status ON public.booking_requests(performer_id, status);

-- –¢—Ä–∏–≥–≥–µ—Ä –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è timestamp
CREATE TRIGGER update_booking_requests_updated_at 
BEFORE UPDATE ON public.booking_requests 
FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();

-- RLS –ø–æ–ª–∏—Ç–∏–∫–∏
ALTER TABLE public.booking_requests ENABLE ROW LEVEL SECURITY;

-- –£—á–∞—Å—Ç–Ω–∏–∫–∏ –≤–∏–¥—è—Ç —Å–≤–æ–∏ –±—É–∫–∏–Ω–≥–∏
CREATE POLICY "Users see own booking requests"
ON public.booking_requests FOR SELECT
USING (
    auth.uid() = requester_id OR 
    auth.uid() = performer_id
);

-- –ê–¥–º–∏–Ω—ã –≤–∏–¥—è—Ç –≤—Å–µ
CREATE POLICY "Admins see all booking requests"
ON public.booking_requests FOR SELECT
USING (public.is_admin(auth.uid()));

-- Venue –º–æ–∂–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å –∑–∞—è–≤–∫–∏
CREATE POLICY "Venues can create booking requests"
ON public.booking_requests FOR INSERT
WITH CHECK (
    auth.uid() = requester_id AND 
    (public.has_role(auth.uid(), 'venue') OR public.has_role(auth.uid(), 'artist'))
);

-- –£—á–∞—Å—Ç–Ω–∏–∫–∏ –º–æ–≥—É—Ç –æ–±–Ω–æ–≤–ª—è—Ç—å —Å–≤–æ–∏ –±—É–∫–∏–Ω–≥–∏
CREATE POLICY "Participants can update bookings"
ON public.booking_requests FOR UPDATE
USING (
    auth.uid() = performer_id OR 
    auth.uid() = requester_id OR
    public.is_admin(auth.uid())
);
```

---

### **2. –¢–∞–±–ª–∏—Ü–∞ booking_calendar**

**–ö–∞–ª–µ–Ω–¥–∞—Ä—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –∞—Ä—Ç–∏—Å—Ç–æ–≤/DJ**

```sql
CREATE TABLE public.booking_calendar (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    -- –ö–æ–º—É –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç –∫–∞–ª–µ–Ω–¥–∞—Ä—å
    performer_id UUID NOT NULL REFERENCES public.profiles(id),
    performer_type TEXT NOT NULL, -- 'artist' –∏–ª–∏ 'dj'
    
    -- –î–∞—Ç–∞
    date DATE NOT NULL,
    
    -- –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å
    is_available BOOLEAN DEFAULT true,
    
    -- –ï—Å–ª–∏ –∑–∞–Ω—è—Ç–æ –±—É–∫–∏–Ω–≥–æ–º
    booking_id UUID REFERENCES public.booking_requests(id),
    
    -- –†—É—á–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞
    is_blocked BOOLEAN DEFAULT false,
    blocked_reason TEXT, -- vacation, personal, maintenance, other
    blocked_note TEXT,
    
    -- –¢–∞–π–º-—Å–ª–æ—Ç—ã (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –¥–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω–æ–≥–æ –∫–æ–Ω—Ç—Ä–æ–ª—è)
    time_slots JSONB DEFAULT '[]', -- [{start: "18:00", end: "23:00", available: true}]
    
    -- –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
    created_at TIMESTAMPTZ DEFAULT now(),
    updated_at TIMESTAMPTZ DEFAULT now(),
    
    -- –£–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å: –æ–¥–∏–Ω performer - –æ–¥–Ω–∞ –¥–∞—Ç–∞
    UNIQUE(performer_id, date)
);

-- –ò–Ω–¥–µ–∫—Å—ã
CREATE INDEX idx_booking_calendar_performer ON public.booking_calendar(performer_id);
CREATE INDEX idx_booking_calendar_date ON public.booking_calendar(date);
CREATE INDEX idx_booking_calendar_performer_date ON public.booking_calendar(performer_id, date);
CREATE INDEX idx_booking_calendar_available ON public.booking_calendar(is_available) WHERE is_available = true;

-- –¢—Ä–∏–≥–≥–µ—Ä
CREATE TRIGGER update_booking_calendar_updated_at 
BEFORE UPDATE ON public.booking_calendar 
FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();

-- RLS
ALTER TABLE public.booking_calendar ENABLE ROW LEVEL SECURITY;

-- Performer —É–ø—Ä–∞–≤–ª—è–µ—Ç —Å–≤–æ–∏–º –∫–∞–ª–µ–Ω–¥–∞—Ä–µ–º
CREATE POLICY "Performers manage own calendar"
ON public.booking_calendar FOR ALL
USING (auth.uid() = performer_id);

-- –í—Å–µ –º–æ–≥—É—Ç –≤–∏–¥–µ—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å (–¥–ª—è –ø–æ–∏—Å–∫–∞)
CREATE POLICY "Anyone can view calendar availability"
ON public.booking_calendar FOR SELECT
TO authenticated
USING (true);
```

---

### **3. –¢–∞–±–ª–∏—Ü–∞ booking_payments**

**–ü–ª–∞—Ç–µ–∂–∏ –ø–æ –±—É–∫–∏–Ω–≥–∞–º**

```sql
CREATE TABLE public.booking_payments (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    -- –°–≤—è–∑—å —Å –±—É–∫–∏–Ω–≥–æ–º
    booking_id UUID NOT NULL REFERENCES public.booking_requests(id),
    
    -- –£—á–∞—Å—Ç–Ω–∏–∫–∏
    payer_id UUID NOT NULL REFERENCES public.profiles(id), -- –ö—Ç–æ –ø–ª–∞—Ç–∏—Ç (venue)
    recipient_id UUID NOT NULL REFERENCES public.profiles(id), -- –ö–æ–º—É (performer –∏–ª–∏ platform)
    
    -- –°—É–º–º–∞
    amount NUMERIC(10,2) NOT NULL,
    currency TEXT DEFAULT 'RUB',
    
    -- –¢–∏–ø –ø–ª–∞—Ç–µ–∂–∞
    payment_type TEXT NOT NULL,
    -- deposit: –¥–µ–ø–æ–∑–∏—Ç 30%
    -- final: —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –ø–ª–∞—Ç–µ–∂ 70%
    -- full: –ø–æ–ª–Ω–∞—è –æ–ø–ª–∞—Ç–∞ —Å—Ä–∞–∑—É (—Ä–µ–¥–∫–æ)
    -- refund: –≤–æ–∑–≤—Ä–∞—Ç
    -- payout: –≤—ã–ø–ª–∞—Ç–∞ –∞—Ä—Ç–∏—Å—Ç—É
    -- cancellation_fee: —à—Ç—Ä–∞—Ñ –∑–∞ –æ—Ç–º–µ–Ω—É
    
    -- –°—Ç–∞—Ç—É—Å
    status TEXT DEFAULT 'pending',
    -- pending: –æ–∂–∏–¥–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏
    -- processing: –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ
    -- completed: –∑–∞–≤–µ—Ä—à–µ–Ω
    -- failed: –æ—à–∏–±–∫–∞
    -- refunded: –≤–æ–∑–≤—Ä–∞—â–µ–Ω
    
    -- Gateway (–ø–ª–∞—Ç–µ–∂–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞)
    gateway TEXT DEFAULT 'stripe', -- stripe, paypal, yookassa, etc
    gateway_payment_id TEXT, -- ID –≤ –ø–ª–∞—Ç–µ–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ
    gateway_response JSONB,
    
    -- –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
    metadata JSONB DEFAULT '{}',
    description TEXT,
    
    -- Timestamps
    created_at TIMESTAMPTZ DEFAULT now(),
    processed_at TIMESTAMPTZ,
    failed_at TIMESTAMPTZ,
    refunded_at TIMESTAMPTZ,
    
    -- –°–≤—è–∑—å —Å –æ—Å–Ω–æ–≤–Ω–æ–π —Ç–∞–±–ª–∏—Ü–µ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
    transaction_id UUID REFERENCES public.payment_transactions(id),
    
    CONSTRAINT valid_payment_type CHECK (payment_type IN (
        'deposit', 'final', 'full', 'refund', 'payout', 'cancellation_fee'
    )),
    CONSTRAINT valid_status CHECK (status IN (
        'pending', 'processing', 'completed', 'failed', 'refunded'
    ))
);

-- –ò–Ω–¥–µ–∫—Å—ã
CREATE INDEX idx_booking_payments_booking ON public.booking_payments(booking_id);
CREATE INDEX idx_booking_payments_payer ON public.booking_payments(payer_id);
CREATE INDEX idx_booking_payments_recipient ON public.booking_payments(recipient_id);
CREATE INDEX idx_booking_payments_status ON public.booking_payments(status);
CREATE INDEX idx_booking_payments_type ON public.booking_payments(payment_type);

-- RLS
ALTER TABLE public.booking_payments ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users see own payments"
ON public.booking_payments FOR SELECT
USING (
    auth.uid() = payer_id OR 
    auth.uid() = recipient_id OR
    public.is_admin(auth.uid())
);
```

---

### **4. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ artist_profiles**

**–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—è –¥–ª—è –±—É–∫–∏–Ω–≥–∞**

```sql
-- –î–æ–±–∞–≤–∏—Ç—å –≤ artist_profiles
ALTER TABLE public.artist_profiles ADD COLUMN IF NOT EXISTS booking_enabled BOOLEAN DEFAULT true;
ALTER TABLE public.artist_profiles ADD COLUMN IF NOT EXISTS hourly_rate NUMERIC(10,2) DEFAULT 10000;
ALTER TABLE public.artist_profiles ADD COLUMN IF NOT EXISTS minimum_booking_hours NUMERIC(4,1) DEFAULT 2;
ALTER TABLE public.artist_profiles ADD COLUMN IF NOT EXISTS booking_info JSONB DEFAULT '{}';
-- {
--   availableDays: ["friday", "saturday"],
--   technicalRider: {...},
--   specialRequirements: "...",
--   cancellationPolicy: "..."
-- }

ALTER TABLE public.artist_profiles ADD COLUMN IF NOT EXISTS total_bookings INTEGER DEFAULT 0;
ALTER TABLE public.artist_profiles ADD COLUMN IF NOT EXISTS completed_bookings INTEGER DEFAULT 0;
ALTER TABLE public.artist_profiles ADD COLUMN IF NOT EXISTS booking_rating NUMERIC(3,2) DEFAULT 5.0;
```

---

### **5. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ dj_profiles**

**–£–∂–µ –µ—Å—Ç—å booking_info, –¥–æ–±–∞–≤–∏—Ç—å –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ**

```sql
-- –î–æ–±–∞–≤–∏—Ç—å –≤ dj_profiles (–µ—Å–ª–∏ –Ω–µ—Ç)
ALTER TABLE public.dj_profiles ADD COLUMN IF NOT EXISTS booking_enabled BOOLEAN DEFAULT true;
ALTER TABLE public.dj_profiles ADD COLUMN IF NOT EXISTS total_bookings INTEGER DEFAULT 0;
ALTER TABLE public.dj_profiles ADD COLUMN IF NOT EXISTS completed_bookings INTEGER DEFAULT 0;
ALTER TABLE public.dj_profiles ADD COLUMN IF NOT EXISTS booking_rating NUMERIC(3,2) DEFAULT 5.0;
```

---

## üí∞ –§–ò–ù–ê–ù–°–û–í–ê–Ø –õ–û–ì–ò–ö–ê

### **–§–æ—Ä–º—É–ª–∞ —Ä–∞—Å—á–µ—Ç–∞:**

```typescript
// –í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
const hourlyRate = 15000; // ‚ÇΩ/—á–∞—Å
const durationHours = 4;  // —á–∞—Å–æ–≤

// –†–∞—Å—á–µ—Ç
const offeredPrice = hourlyRate * durationHours; // 60,000‚ÇΩ
const platformCommission = offeredPrice * 0.10;   // 6,000‚ÇΩ (10%)
const performerFee = offeredPrice - platformCommission; // 54,000‚ÇΩ

// –î–µ–ø–æ–∑–∏—Ç (30%)
const depositPercentage = 0.30;
const depositAmount = offeredPrice * depositPercentage; // 18,000‚ÇΩ

// –§–∏–Ω–∞–ª—å–Ω—ã–π –ø–ª–∞—Ç–µ–∂ (70%)
const finalPercentage = 0.70;
const finalAmount = offeredPrice * finalPercentage; // 42,000‚ÇΩ

// –ü—Ä–æ–≤–µ—Ä–∫–∞
console.assert(depositAmount + finalAmount === offeredPrice);
```

### **–ü—Ä–∏–º–µ—Ä:**

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ó–Ω–∞—á–µ–Ω–∏–µ |
|----------|----------|
| –°—Ç–∞–≤–∫–∞ | 15,000‚ÇΩ/—á–∞—Å |
| –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å | 4 —á–∞—Å–∞ |
| **–ü–æ–ª–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å** | **60,000‚ÇΩ** |
| –ö–æ–º–∏—Å—Å–∏—è –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã (10%) | 6,000‚ÇΩ |
| **–ê—Ä—Ç–∏—Å—Ç—É** | **54,000‚ÇΩ** |
| –î–µ–ø–æ–∑–∏—Ç (30%) | 18,000‚ÇΩ |
| –û—Å—Ç–∞—Ç–æ–∫ (70%) | 42,000‚ÇΩ |

---

### **Workflow –ø–ª–∞—Ç–µ–∂–µ–π:**

```
1Ô∏è‚É£ –°–û–ó–î–ê–ù–ò–ï –ó–ê–Ø–í–ö–ò (status: pending)
   Venue: –°–æ–∑–¥–∞–µ—Ç –∑–∞—è–≤–∫—É
   System: –†–∞—Å—á–µ—Ç —Ü–µ–Ω (offered_price, performer_fee, commission)
   
2Ô∏è‚É£ –ü–†–ò–ù–Ø–¢–ò–ï –ê–†–¢–ò–°–¢–û–ú (status: accepted)
   Artist: –ù–∞–∂–∏–º–∞–µ—Ç "–ü—Ä–∏–Ω—è—Ç—å"
   System: –†–∞—Å—á–µ—Ç –¥–µ–ø–æ–∑–∏—Ç–∞ (30%)
   Venue: –ü–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ "–û–ø–ª–∞—Ç–∏—Ç–µ –¥–µ–ø–æ–∑–∏—Ç"
   
3Ô∏è‚É£ –û–ü–õ–ê–¢–ê –î–ï–ü–û–ó–ò–¢–ê (status: deposit_paid)
   Venue: –ü–ª–∞—Ç–∏—Ç 18,000‚ÇΩ
   System: 
     - –°–æ–∑–¥–∞–µ—Ç booking_payment (type: deposit)
     - –û–±–Ω–æ–≤–ª—è–µ—Ç booking_request.deposit_paid_at
     - –ë–ª–æ–∫–∏—Ä—É–µ—Ç –¥–∞—Ç—É –≤ booking_calendar
   Artist: –ü–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ "–î–µ–ø–æ–∑–∏—Ç –ø–æ–ª—É—á–µ–Ω"
   
4Ô∏è‚É£ –ù–ê–ü–û–ú–ò–ù–ê–ù–ò–ï –ó–ê 24 –ß–ê–°–ê
   System: –ó–∞ 24—á –¥–æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è
   Venue: –ü–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ "–û–ø–ª–∞—Ç–∏—Ç–µ –æ—Å—Ç–∞—Ç–æ–∫"
   
5Ô∏è‚É£ –§–ò–ù–ê–õ–¨–ù–´–ô –ü–õ–ê–¢–ï–ñ (status: confirmed)
   Venue: –ü–ª–∞—Ç–∏—Ç 42,000‚ÇΩ
   System:
     - –°–æ–∑–¥–∞–µ—Ç booking_payment (type: final)
     - –û–±–Ω–æ–≤–ª—è–µ—Ç booking_request.full_payment_at
     - –°—Ç–∞—Ç—É—Å ‚Üí confirmed
   Artist: –ü–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ "–ë—É–∫–∏–Ω–≥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω"
   
6Ô∏è‚É£ –ú–ï–†–û–ü–†–ò–Ø–¢–ò–ï –ü–†–û–•–û–î–ò–¢
   System: –ü–æ—Å–ª–µ event_date
   
7Ô∏è‚É£ –ó–ê–í–ï–†–®–ï–ù–ò–ï (status: completed)
   System: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ 24—á –ø–æ—Å–ª–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è
   Status ‚Üí completed
   Venue & Artist: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ "–û—Å—Ç–∞–≤—å—Ç–µ –æ—Ç–∑—ã–≤"
   
8Ô∏è‚É£ –í–´–ü–õ–ê–¢–ê –ê–†–¢–ò–°–¢–£
   System: –ü–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç–∑—ã–≤–æ–≤ (–∏–ª–∏ —á–µ—Ä–µ–∑ 7 –¥–Ω–µ–π)
   Artist: –ü–æ–ª—É—á–∞–µ—Ç 54,000‚ÇΩ –Ω–∞ –±–∞–ª–∞–Ω—Å
   System:
     - –°–æ–∑–¥–∞–µ—Ç booking_payment (type: payout, recipient: artist)
     - –û–±–Ω–æ–≤–ª—è–µ—Ç booking_request.payout_at
     - Payout_status ‚Üí completed
```

---

## üö´ –ü–û–õ–ò–¢–ò–ö–ê –û–¢–ú–ï–ù–´

### **–¢–∞–±–ª–∏—Ü–∞ –≤–æ–∑–≤—Ä–∞—Ç–æ–≤:**

| –ö–æ–≥–¥–∞ –æ—Ç–º–µ–Ω–µ–Ω–æ | Venue –≤–æ–∑–≤—Ä–∞—Ç | Artist –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏—è | Platform |
|----------------|---------------|-------------------|----------|
| **–î–æ –¥–µ–ø–æ–∑–∏—Ç–∞** | 100% (0‚ÇΩ –ø–æ—Ç–µ—Ä—è) | 0% | –ö–æ–º–∏—Å—Å–∏—è 0‚ÇΩ |
| **–ü–æ—Å–ª–µ –¥–µ–ø–æ–∑–∏—Ç–∞, >14 –¥–Ω–µ–π** | 100% (–≤–æ–∑–≤—Ä–∞—Ç 18,000‚ÇΩ) | 0% | –ö–æ–º–∏—Å—Å–∏—è 0‚ÇΩ |
| **7-14 –¥–Ω–µ–π –¥–æ** | 70% (–≤–æ–∑–≤—Ä–∞—Ç 12,600‚ÇΩ) | 30% –¥–µ–ø–æ–∑–∏—Ç–∞ (5,400‚ÇΩ) | –ö–æ–º–∏—Å—Å–∏—è 540‚ÇΩ |
| **3-7 –¥–Ω–µ–π –¥–æ** | 50% (–≤–æ–∑–≤—Ä–∞—Ç 9,000‚ÇΩ) | 50% –¥–µ–ø–æ–∑–∏—Ç–∞ (9,000‚ÇΩ) | –ö–æ–º–∏—Å—Å–∏—è 900‚ÇΩ |
| **<3 –¥–Ω–µ–π –¥–æ** | 0% (–ø–æ—Ç–µ—Ä—è 18,000‚ÇΩ) | 100% –¥–µ–ø–æ–∑–∏—Ç–∞ (18,000‚ÇΩ) | –ö–æ–º–∏—Å—Å–∏—è 1,800‚ÇΩ |
| **–ü–æ—Å–ª–µ –ø–æ–ª–Ω–æ–π –æ–ø–ª–∞—Ç—ã** | 0% (–ø–æ—Ç–µ—Ä—è 60,000‚ÇΩ) | 100% (–ø–æ–ª—É—á–∞–µ—Ç 60,000‚ÇΩ) | –ö–æ–º–∏—Å—Å–∏—è 6,000‚ÇΩ |
| **–û—Ç–º–µ–Ω–∏–ª Artist** | 100% + —à—Ç—Ä–∞—Ñ | -—à—Ç—Ä–∞—Ñ 10,000‚ÇΩ | –®—Ç—Ä–∞—Ñ –∞—Ä—Ç–∏—Å—Ç—É |

### **–§–æ—Ä–º—É–ª–∞ —à—Ç—Ä–∞—Ñ–∞ –∑–∞ –æ—Ç–º–µ–Ω—É –∞—Ä—Ç–∏—Å—Ç–æ–º:**

```typescript
const artistCancellationFee = Math.min(
  performerFee * 0.50, // 50% –æ—Ç –≥–æ–Ω–æ—Ä–∞—Ä–∞
  20000 // –ú–∞–∫—Å–∏–º—É–º 20,000‚ÇΩ
);

// –ü—Ä–∏–º–µ—Ä: 54,000‚ÇΩ * 0.50 = 27,000‚ÇΩ ‚Üí cap at 20,000‚ÇΩ
```

---

## üîî –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø

### **–¢–∏–ø—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:**

| –°–æ–±—ã—Ç–∏–µ | –ü–æ–ª—É—á–∞—Ç–µ–ª—å | –¢–∏–ø | –¢–µ–∫—Å—Ç |
|---------|-----------|-----|-------|
| –ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ | Artist | `booking_request_new` | "üé§ –ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ –æ—Ç {venue_name}" |
| –ó–∞—è–≤–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞ | Venue | `booking_accepted` | "‚úÖ {artist_name} –ø—Ä–∏–Ω—è–ª –∑–∞—è–≤–∫—É" |
| –ó–∞—è–≤–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞ | Venue | `booking_rejected` | "‚ùå {artist_name} –æ—Ç–∫–ª–æ–Ω–∏–ª –∑–∞—è–≤–∫—É" |
| –î–µ–ø–æ–∑–∏—Ç –æ–ø–ª–∞—á–µ–Ω | Artist | `booking_deposit_paid` | "üí∞ –î–µ–ø–æ–∑–∏—Ç {amount}‚ÇΩ –ø–æ–ª—É—á–µ–Ω" |
| –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ–ø–ª–∞—Ç–∏—Ç—å | Venue | `booking_payment_reminder` | "‚è∞ –û–ø–ª–∞—Ç–∏—Ç–µ –æ—Å—Ç–∞—Ç–æ–∫ –∑–∞ 24—á" |
| –ü–æ–ª–Ω–∞—è –æ–ø–ª–∞—Ç–∞ | Artist | `booking_confirmed` | "üéâ –ë—É–∫–∏–Ω–≥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω!" |
| –ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ –∑–∞–≤—Ç—Ä–∞ | Both | `booking_tomorrow` | "üìÖ –ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ –∑–∞–≤—Ç—Ä–∞" |
| –ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ | Both | `booking_completed` | "‚≠ê –û—Å—Ç–∞–≤—å—Ç–µ –æ—Ç–∑—ã–≤" |
| –í—ã–ø–ª–∞—Ç–∞ –∞—Ä—Ç–∏—Å—Ç—É | Artist | `booking_payout` | "üí∏ –í—ã–ø–ª–∞—Ç–∞ {amount}‚ÇΩ –Ω–∞ –±–∞–ª–∞–Ω—Å" |
| –û—Ç–º–µ–Ω–∞ –±—É–∫–∏–Ω–≥–∞ | Both | `booking_cancelled` | "üö´ –ë—É–∫–∏–Ω–≥ –æ—Ç–º–µ–Ω–µ–Ω" |

---

## üì° API ENDPOINTS

### **–î–ª—è –∑–∞–≤–µ–¥–µ–Ω–∏–π (Venue):**

| Method | Endpoint | –û–ø–∏—Å–∞–Ω–∏–µ |
|--------|----------|----------|
| GET | `/api/artists/search` | –ü–æ–∏—Å–∫ –∞—Ä—Ç–∏—Å—Ç–æ–≤ —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏ |
| GET | `/api/artists/:id` | –ü—Ä–æ—Ñ–∏–ª—å –∞—Ä—Ç–∏—Å—Ç–∞ |
| GET | `/api/artists/:id/availability` | –ö–∞–ª–µ–Ω–¥–∞—Ä—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ |
| POST | `/api/bookings/create` | –°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É |
| GET | `/api/bookings` | –ú–æ–∏ –±—É–∫–∏–Ω–≥–∏ (–∫–∞–∫ requester) |
| GET | `/api/bookings/:id` | –î–µ—Ç–∞–ª–∏ –±—É–∫–∏–Ω–≥–∞ |
| PUT | `/api/bookings/:id/cancel` | –û—Ç–º–µ–Ω–∏—Ç—å –±—É–∫–∏–Ω–≥ |
| POST | `/api/bookings/:id/pay-deposit` | –û–ø–ª–∞—Ç–∏—Ç—å –¥–µ–ø–æ–∑–∏—Ç |
| POST | `/api/bookings/:id/pay-final` | –û–ø–ª–∞—Ç–∏—Ç—å –æ—Å—Ç–∞—Ç–æ–∫ |
| POST | `/api/bookings/:id/review` | –û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤ |

### **–î–ª—è –∞—Ä—Ç–∏—Å—Ç–æ–≤ (Artist/DJ):**

| Method | Endpoint | –û–ø–∏—Å–∞–Ω–∏–µ |
|--------|----------|----------|
| GET | `/api/bookings/incoming` | –í—Ö–æ–¥—è—â–∏–µ –∑–∞—è–≤–∫–∏ |
| PUT | `/api/bookings/:id/accept` | –ü—Ä–∏–Ω—è—Ç—å –∑–∞—è–≤–∫—É |
| PUT | `/api/bookings/:id/reject` | –û—Ç–∫–ª–æ–Ω–∏—Ç—å –∑–∞—è–≤–∫—É |
| GET | `/api/bookings/my` | –ú–æ–∏ –±—É–∫–∏–Ω–≥–∏ (–∫–∞–∫ performer) |
| GET | `/api/bookings/:id` | –î–µ—Ç–∞–ª–∏ –±—É–∫–∏–Ω–≥–∞ |
| PUT | `/api/bookings/:id/cancel` | –û—Ç–º–µ–Ω–∏—Ç—å –±—É–∫–∏–Ω–≥ |
| GET | `/api/bookings/calendar` | –ú–æ–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å |
| PUT | `/api/bookings/calendar` | –û–±–Ω–æ–≤–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å |
| POST | `/api/bookings/calendar/block` | –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –¥–∞—Ç—ã |
| GET | `/api/bookings/earnings` | –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞—Ä–∞–±–æ—Ç–∫–∞ |
| POST | `/api/bookings/:id/review` | –û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤ |

### **–ê–¥–º–∏–Ω:**

| Method | Endpoint | –û–ø–∏—Å–∞–Ω–∏–µ |
|--------|----------|----------|
| GET | `/api/admin/bookings` | –í—Å–µ –±—É–∫–∏–Ω–≥–∏ |
| PUT | `/api/admin/bookings/:id/moderate` | –ú–æ–¥–µ—Ä–∞—Ü–∏—è |
| POST | `/api/admin/bookings/:id/refund` | –í–æ–∑–≤—Ä–∞—Ç |
| GET | `/api/admin/bookings/analytics` | –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ |

---

## üóÇÔ∏è EDGE FUNCTIONS

### **1. create-booking-request**

**–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞—è–≤–∫–∏ –æ—Ç venue**

```typescript
// /supabase/functions/server/routes/bookings/create.ts

export async function createBookingRequest(c: Context) {
  const user = c.get('user');
  const body = await c.req.json();
  
  // –í–∞–ª–∏–¥–∞—Ü–∏—è
  const {
    performerId,
    performerType,
    eventType,
    eventTitle,
    eventDate,
    startTime,
    durationHours,
    venueAddress,
    expectedAudience,
    technicalRequirements,
  } = body;
  
  // –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞–≤–∫—É performer'–∞
  const { data: performer } = await supabase
    .from(performerType === 'dj' ? 'dj_profiles' : 'artist_profiles')
    .select('hourly_rate, minimum_booking_hours')
    .eq('user_id', performerId)
    .single();
  
  if (!performer) {
    return c.json({ error: 'Performer not found' }, 404);
  }
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–Ω–∏–º—É–º–∞
  if (durationHours < performer.minimum_booking_hours) {
    return c.json({ 
      error: `Minimum booking is ${performer.minimum_booking_hours} hours` 
    }, 400);
  }
  
  // –†–∞—Å—á–µ—Ç —Ü–µ–Ω
  const offeredPrice = performer.hourly_rate * durationHours;
  const platformCommission = offeredPrice * 0.10;
  const performerFee = offeredPrice - platformCommission;
  const depositAmount = offeredPrice * 0.30;
  const finalAmount = offeredPrice * 0.70;
  
  // –°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É
  const { data: booking, error } = await supabase
    .from('booking_requests')
    .insert({
      requester_id: user.id,
      requester_type: 'venue',
      performer_id: performerId,
      performer_type: performerType,
      event_type: eventType,
      event_title: eventTitle,
      event_date: eventDate,
      start_time: startTime,
      duration_hours: durationHours,
      venue_address: venueAddress,
      expected_audience: expectedAudience,
      offered_price: offeredPrice,
      performer_fee: performerFee,
      platform_commission: platformCommission,
      deposit_amount: depositAmount,
      final_amount: finalAmount,
      technical_requirements: technicalRequirements,
      status: 'pending',
    })
    .select()
    .single();
  
  if (error) {
    return c.json({ error: error.message }, 500);
  }
  
  // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞—Ä—Ç–∏—Å—Ç—É
  await sendNotification({
    userId: performerId,
    type: 'booking_request_new',
    title: '–ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ –Ω–∞ –±—É–∫–∏–Ω–≥',
    message: `–ó–∞–≤–µ–¥–µ–Ω–∏–µ —Ö–æ—á–µ—Ç –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –≤–∞—Å –Ω–∞ ${eventDate}`,
    data: { bookingId: booking.id },
  });
  
  return c.json({ booking });
}
```

---

### **2. respond-booking-request**

**–ü—Ä–∏–Ω—è—Ç—å/–æ—Ç–∫–ª–æ–Ω–∏—Ç—å –∑–∞—è–≤–∫—É (Artist/DJ)**

```typescript
// /supabase/functions/server/routes/bookings/respond.ts

export async function respondBookingRequest(c: Context) {
  const user = c.get('user');
  const bookingId = c.req.param('id');
  const { action, rejectionReason } = await c.req.json(); // 'accept' or 'reject'
  
  // –ü–æ–ª—É—á–∏—Ç—å –±—É–∫–∏–Ω–≥
  const { data: booking } = await supabase
    .from('booking_requests')
    .select('*')
    .eq('id', bookingId)
    .eq('performer_id', user.id)
    .single();
  
  if (!booking) {
    return c.json({ error: 'Booking not found' }, 404);
  }
  
  if (booking.status !== 'pending') {
    return c.json({ error: 'Booking already processed' }, 400);
  }
  
  if (action === 'accept') {
    // –ü—Ä–∏–Ω—è—Ç—å
    const { data: updated } = await supabase
      .from('booking_requests')
      .update({
        status: 'accepted',
        accepted_at: new Date().toISOString(),
      })
      .eq('id', bookingId)
      .select()
      .single();
    
    // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ venue
    await sendNotification({
      userId: booking.requester_id,
      type: 'booking_accepted',
      title: '–ó–∞—è–≤–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞!',
      message: `–ê—Ä—Ç–∏—Å—Ç –ø—Ä–∏–Ω—è–ª –≤–∞—à—É –∑–∞—è–≤–∫—É. –û–ø–ª–∞—Ç–∏—Ç–µ –¥–µ–ø–æ–∑–∏—Ç ${booking.deposit_amount}‚ÇΩ`,
      data: { bookingId: booking.id },
    });
    
    return c.json({ booking: updated });
    
  } else if (action === 'reject') {
    // –û—Ç–∫–ª–æ–Ω–∏—Ç—å
    const { data: updated } = await supabase
      .from('booking_requests')
      .update({
        status: 'rejected',
        rejected_at: new Date().toISOString(),
        cancellation_reason: rejectionReason,
        cancelled_by: user.id,
      })
      .eq('id', bookingId)
      .select()
      .single();
    
    // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ venue
    await sendNotification({
      userId: booking.requester_id,
      type: 'booking_rejected',
      title: '–ó–∞—è–≤–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞',
      message: `–ê—Ä—Ç–∏—Å—Ç –æ—Ç–∫–ª–æ–Ω–∏–ª –≤–∞—à—É –∑–∞—è–≤–∫—É`,
      data: { bookingId: booking.id },
    });
    
    return c.json({ booking: updated });
  }
  
  return c.json({ error: 'Invalid action' }, 400);
}
```

---

### **3. process-booking-deposit**

**–û–ø–ª–∞—Ç–∞ –¥–µ–ø–æ–∑–∏—Ç–∞ (30%)**

```typescript
// /supabase/functions/server/routes/bookings/pay-deposit.ts

export async function processBookingDeposit(c: Context) {
  const user = c.get('user');
  const bookingId = c.req.param('id');
  const { paymentMethodId } = await c.req.json(); // Stripe payment method
  
  // –ü–æ–ª—É—á–∏—Ç—å –±—É–∫–∏–Ω–≥
  const { data: booking } = await supabase
    .from('booking_requests')
    .select('*')
    .eq('id', bookingId)
    .eq('requester_id', user.id)
    .single();
  
  if (!booking || booking.status !== 'accepted') {
    return c.json({ error: 'Invalid booking' }, 400);
  }
  
  // –°–æ–∑–¥–∞—Ç—å –ø–ª–∞—Ç–µ–∂ —á–µ—Ä–µ–∑ Stripe (mock)
  const paymentIntent = await createStripePayment({
    amount: booking.deposit_amount * 100, // –≤ –∫–æ–ø–µ–π–∫–∞—Ö
    currency: 'rub',
    customerId: user.id,
    paymentMethodId,
    metadata: {
      bookingId: booking.id,
      type: 'deposit',
    },
  });
  
  if (paymentIntent.status !== 'succeeded') {
    return c.json({ error: 'Payment failed' }, 400);
  }
  
  // –û–±–Ω–æ–≤–∏—Ç—å –±—É–∫–∏–Ω–≥
  const { data: updated } = await supabase
    .from('booking_requests')
    .update({
      status: 'deposit_paid',
      deposit_paid_at: new Date().toISOString(),
    })
    .eq('id', bookingId)
    .select()
    .single();
  
  // –°–æ–∑–¥–∞—Ç—å payment record
  await supabase.from('booking_payments').insert({
    booking_id: bookingId,
    payer_id: user.id,
    recipient_id: 'platform', // —Å–Ω–∞—á–∞–ª–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ
    amount: booking.deposit_amount,
    payment_type: 'deposit',
    status: 'completed',
    gateway: 'stripe',
    gateway_payment_id: paymentIntent.id,
    processed_at: new Date().toISOString(),
  });
  
  // –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –¥–∞—Ç—É –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ
  await supabase.from('booking_calendar').upsert({
    performer_id: booking.performer_id,
    date: booking.event_date,
    is_available: false,
    booking_id: bookingId,
  });
  
  // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞—Ä—Ç–∏—Å—Ç—É
  await sendNotification({
    userId: booking.performer_id,
    type: 'booking_deposit_paid',
    title: '–î–µ–ø–æ–∑–∏—Ç –ø–æ–ª—É—á–µ–Ω!',
    message: `–î–µ–ø–æ–∑–∏—Ç ${booking.deposit_amount}‚ÇΩ –æ–ø–ª–∞—á–µ–Ω. –î–∞—Ç–∞ –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∞.`,
    data: { bookingId: booking.id },
  });
  
  return c.json({ booking: updated, payment: paymentIntent });
}
```

---

### **4. complete-booking-and-payout**

**–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∏ –≤—ã–ø–ª–∞—Ç–∞ –∞—Ä—Ç–∏—Å—Ç—É**

```typescript
// /supabase/functions/server/routes/bookings/complete.ts

export async function completeBookingAndPayout(c: Context) {
  const bookingId = c.req.param('id');
  
  // –ü–æ–ª—É—á–∏—Ç—å –±—É–∫–∏–Ω–≥
  const { data: booking } = await supabase
    .from('booking_requests')
    .select('*')
    .eq('id', bookingId)
    .eq('status', 'confirmed')
    .single();
  
  if (!booking) {
    return c.json({ error: 'Booking not found or not confirmed' }, 404);
  }
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞: –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ –ø—Ä–æ—à–ª–æ?
  const eventDate = new Date(booking.event_date);
  const now = new Date();
  if (eventDate > now) {
    return c.json({ error: 'Event has not occurred yet' }, 400);
  }
  
  // –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å
  await supabase
    .from('booking_requests')
    .update({
      status: 'completed',
    })
    .eq('id', bookingId);
  
  // –í—ã–ø–ª–∞—Ç–∞ –∞—Ä—Ç–∏—Å—Ç—É (performer_fee)
  const { data: payout } = await supabase
    .from('booking_payments')
    .insert({
      booking_id: bookingId,
      payer_id: 'platform',
      recipient_id: booking.performer_id,
      amount: booking.performer_fee,
      payment_type: 'payout',
      status: 'completed',
      processed_at: new Date().toISOString(),
    })
    .select()
    .single();
  
  // –û–±–Ω–æ–≤–∏—Ç—å –±—É–∫–∏–Ω–≥ —Å payout info
  await supabase
    .from('booking_requests')
    .update({
      payout_amount: booking.performer_fee,
      payout_at: new Date().toISOString(),
      payout_transaction_id: payout.id,
      payout_status: 'completed',
    })
    .eq('id', bookingId);
  
  // –ù–∞—á–∏—Å–ª–∏—Ç—å –±–∞–ª–∞–Ω—Å –∞—Ä—Ç–∏—Å—Ç—É
  await supabase.rpc('add_balance', {
    user_id: booking.performer_id,
    amount: booking.performer_fee,
  });
  
  // –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
  await supabase
    .from(booking.performer_type === 'dj' ? 'dj_profiles' : 'artist_profiles')
    .update({
      completed_bookings: supabase.raw('completed_bookings + 1'),
    })
    .eq('user_id', booking.performer_id);
  
  // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
  await sendNotification({
    userId: booking.performer_id,
    type: 'booking_payout',
    title: '–í—ã–ø–ª–∞—Ç–∞ –ø–æ–ª—É—á–µ–Ω–∞!',
    message: `${booking.performer_fee}‚ÇΩ –∑–∞—á–∏—Å–ª–µ–Ω–æ –Ω–∞ –±–∞–ª–∞–Ω—Å`,
    data: { bookingId: booking.id },
  });
  
  await sendNotification({
    userId: booking.requester_id,
    type: 'booking_completed',
    title: '–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ',
    message: '–û—Å—Ç–∞–≤—å—Ç–µ –æ—Ç–∑—ã–≤ –æ —Ä–∞–±–æ—Ç–µ –∞—Ä—Ç–∏—Å—Ç–∞',
    data: { bookingId: booking.id },
  });
  
  await sendNotification({
    userId: booking.performer_id,
    type: 'booking_completed',
    title: '–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ',
    message: '–û—Å—Ç–∞–≤—å—Ç–µ –æ—Ç–∑—ã–≤ –æ –∑–∞–≤–µ–¥–µ–Ω–∏–∏',
    data: { bookingId: booking.id },
  });
  
  return c.json({ success: true, payout });
}
```

---

## üé® UI –ö–û–ú–ü–û–ù–ï–ù–¢–´ –î–õ–Ø –ê–†–¢–ò–°–¢–ê

### **–°—Ç—Ä—É–∫—Ç—É—Ä–∞:**

```
/src/artist/
  components/
    artist-bookings-section.tsx    - –ì–ª–∞–≤–Ω–∞—è —Å–µ–∫—Ü–∏—è –±—É–∫–∏–Ω–≥–æ–≤
    booking-request-card.tsx       - –ö–∞—Ä—Ç–æ—á–∫–∞ –≤—Ö–æ–¥—è—â–µ–π –∑–∞—è–≤–∫–∏
    booking-calendar-view.tsx      - –ö–∞–ª–µ–Ω–¥–∞—Ä—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏
    booking-earnings-stats.tsx     - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞—Ä–∞–±–æ—Ç–∫–∞
    booking-action-modal.tsx       - –ú–æ–¥–∞–ª–∫–∞ –ø—Ä–∏–Ω—è—Ç—å/–æ—Ç–∫–ª–æ–Ω–∏—Ç—å
```

### **–í–∫–ª–∞–¥–∫–∏ –≤ –∫–∞–±–∏–Ω–µ—Ç–µ –∞—Ä—Ç–∏—Å—Ç–∞:**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  [–í—Ö–æ–¥—è—â–∏–µ 3]  [–ê–∫—Ç–∏–≤–Ω—ã–µ]  [–ò—Å—Ç–æ—Ä–∏—è]  [‚ÇΩ –ó–∞—Ä–∞–±–æ—Ç–æ–∫]  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üìà –°–¢–ê–¢–ò–°–¢–ò–ö–ê –ò –ê–ù–ê–õ–ò–¢–ò–ö–ê

### **–î–ª—è –∞—Ä—Ç–∏—Å—Ç–∞:**

- –í—Ö–æ–¥—è—â–∏–µ –∑–∞—è–≤–∫–∏ (pending)
- –ê–∫—Ç–∏–≤–Ω—ã–µ –±—É–∫–∏–Ω–≥–∏ (accepted, deposit_paid, confirmed)
- –ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ (completed)
- –ó–∞—Ä–∞–±–æ—Ç–æ–∫ –∑–∞ –ø–µ—Ä–∏–æ–¥
- –°—Ä–µ–¥–Ω–∏–π —á–µ–∫
- –†–µ–π—Ç–∏–Ω–≥ –±—É–∫–∏–Ω–≥–æ–≤
- –¢–æ–ø –∑–∞–≤–µ–¥–µ–Ω–∏–π

### **–î–ª—è venue:**

- –ê–∫—Ç–∏–≤–Ω—ã–µ –±—É–∫–∏–Ω–≥–∏
- –ò—Å—Ç–æ—Ä–∏—è –±—É–∫–∏–Ω–≥–æ–≤
- –ü–æ—Ç—Ä–∞—á–µ–Ω–Ω–∞—è —Å—É–º–º–∞
- –õ—é–±–∏–º—ã–µ –∞—Ä—Ç–∏—Å—Ç—ã
- –ü—Ä–µ–¥—Å—Ç–æ—è—â–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è

---

## ‚úÖ –ß–ï–ö–õ–ò–°–¢ –†–ï–ê–õ–ò–ó–ê–¶–ò–ò

**SQL:**
- [ ] –°–æ–∑–¥–∞—Ç—å booking_requests
- [ ] –°–æ–∑–¥–∞—Ç—å booking_calendar
- [ ] –°–æ–∑–¥–∞—Ç—å booking_payments
- [ ] –û–±–Ω–æ–≤–∏—Ç—å artist_profiles
- [ ] –û–±–Ω–æ–≤–∏—Ç—å dj_profiles
- [ ] RLS –ø–æ–ª–∏—Ç–∏–∫–∏

**Backend:**
- [ ] create-booking-request
- [ ] respond-booking-request
- [ ] process-booking-deposit
- [ ] process-booking-final
- [ ] complete-booking-and-payout
- [ ] cancel-booking-with-refund

**Frontend - Venue:**
- [x] –ü–æ–∏—Å–∫ –∞—Ä—Ç–∏—Å—Ç–æ–≤
- [x] –ö–∞—Ä—Ç–æ—á–∫–∏ –∞—Ä—Ç–∏—Å—Ç–æ–≤
- [x] –ü—Ä–æ—Ñ–∏–ª—å –∞—Ä—Ç–∏—Å—Ç–∞ (modal)
- [x] –§–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞—è–≤–∫–∏
- [x] –°–ø–∏—Å–æ–∫ –º–æ–∏—Ö –±—É–∫–∏–Ω–≥–æ–≤
- [ ] –û–ø–ª–∞—Ç–∞ –¥–µ–ø–æ–∑–∏—Ç–∞/–æ—Å—Ç–∞—Ç–∫–∞
- [ ] –û—Ç–∑—ã–≤—ã –ø–æ—Å–ª–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è

**Frontend - Artist:**
- [ ] –í—Ö–æ–¥—è—â–∏–µ –∑–∞—è–≤–∫–∏
- [ ] –ö–∞—Ä—Ç–æ—á–∫–∞ –∑–∞—è–≤–∫–∏ —Å –¥–µ—Ç–∞–ª—è–º–∏
- [ ] –ü—Ä–∏–Ω—è—Ç—å/–æ—Ç–∫–ª–æ–Ω–∏—Ç—å (modal)
- [ ] –ö–∞–ª–µ–Ω–¥–∞—Ä—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏
- [ ] –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –¥–∞—Ç
- [ ] –ò—Å—Ç–æ—Ä–∏—è –±—É–∫–∏–Ω–≥–æ–≤
- [ ] –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞—Ä–∞–±–æ—Ç–∫–∞
- [ ] –û—Ç–∑—ã–≤—ã –ø–æ—Å–ª–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è

**–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:**
- [ ] –ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ ‚Üí Artist
- [ ] –ó–∞—è–≤–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞/–æ—Ç–∫–ª–æ–Ω–µ–Ω–∞ ‚Üí Venue
- [ ] –î–µ–ø–æ–∑–∏—Ç –æ–ø–ª–∞—á–µ–Ω ‚Üí Artist
- [ ] –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ–ø–ª–∞—Ç–∏—Ç—å ‚Üí Venue
- [ ] –ë—É–∫–∏–Ω–≥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω ‚Üí Artist
- [ ] –ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ –∑–∞–≤—Ç—Ä–∞ ‚Üí Both
- [ ] –ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ ‚Üí Both
- [ ] –í—ã–ø–ª–∞—Ç–∞ ‚Üí Artist

---

## üéâ –ò–¢–û–ì

**–°–æ–∑–¥–∞–Ω–∞ –ø–æ–ª–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –±—É–∫–∏–Ω–≥-—Å–∏—Å—Ç–µ–º—ã:**

‚úÖ SQL —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ (3 —Ç–∞–±–ª–∏—Ü—ã)  
‚úÖ –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ (–¥–µ–ø–æ–∑–∏—Ç/–æ—Å—Ç–∞—Ç–æ–∫/–≤—ã–ø–ª–∞—Ç–∞)  
‚úÖ Workflow (8 —Å—Ç–∞—Ç—É—Å–æ–≤)  
‚úÖ –ü–æ–ª–∏—Ç–∏–∫–∞ –æ—Ç–º–µ–Ω—ã  
‚úÖ API endpoints (20+)  
‚úÖ Edge functions (6)  
‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (10 —Ç–∏–ø–æ–≤)  
‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è  

**–ì–æ—Ç–æ–≤–æ –∫ –∏–º–ø–ª–µ–º–µ–Ω—Ç–∞—Ü–∏–∏!** üöÄ
